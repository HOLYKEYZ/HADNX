"""
Malware and Phishing Detection Service.
Analyzes content for heuristic signs of phishing or malicious scripts.
"""
from typing import List, Dict, Any
from dataclasses import dataclass, field, asdict
import re

@dataclass
class FindingData:
    issue: str
    severity: str
    category: str = 'malware'
    impact: str = ''
    recommendation: str = ''
    fix_examples: Dict[str, str] = field(default_factory=dict)
    affected_element: str = ''
    score_impact: int = 0
    # Phase 2 fields
    confidence: str = 'HIGH'
    evidence: str = ''
    poc: str = ''
    description: str = ''

class MalwareScanner:
    """
    Heuristic scanner for phishing and malware indicators.
    """
    
    def __init__(self):
        self.phishing_keywords = [
            r'verify your account', r'confirm password', r'billing update',
            r'urgent action required', r'security alert', r'unlock.*account'
        ]
        self.malicious_scripts = [
            r'eval\(', r'document\.write\(unescape\(', r'coinhive', r'crypto-loot'
        ]

    def run(self, html_content: str, url: str) -> List[FindingData]:
        findings = []
        if not html_content:
            return []
            
        lowercase_html = html_content.lower()
        
        # 1. Check for Phishing Keywords in Body
        # Only relevant if it looks like a login page but isn't on a known safe domain (hard to judge, so we rely on content)
        found_keywords = []
        for regex in self.phishing_keywords:
             if re.search(regex, lowercase_html):
                 found_keywords.append(regex)
        
        if found_keywords and len(found_keywords) >= 2:
            findings.append(FindingData(
                issue="Potential Phishing Content Detected",
                severity="HIGH",
                category="malware",
                impact="The page contains multiple keywords often used in phishing attacks (social engineering).",
                recommendation="Review the content. If this is legitimate, ensure it doesn't mimic other brands.",
                affected_element=f"Keywords: {', '.join(found_keywords)}",
                score_impact=15
            ))

        # 2. Check for Malicious Scripts (Basic Obfuscation/Miners)
        for regex in self.malicious_scripts:
            if re.search(regex, lowercase_html):
                findings.append(FindingData(
                    issue="Suspicious JavaScript Detected",
                    severity="HIGH",
                    category="malware",
                    impact="The page contains script patterns often associated with malware or obfuscation.",
                    recommendation="Audit third-party scripts and remove any unrecognized code.",
                    affected_element=f"Pattern: {regex}",
                    score_impact=20
                ))

        return findings

def run_malware_scan(url: str, html_content: str) -> List[Dict[str, Any]]:
    scanner = MalwareScanner()
    findings = scanner.run(html_content, url)
    return [asdict(f) for f in findings]
